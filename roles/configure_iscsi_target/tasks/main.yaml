---
- name: Install iSCSI target packages
  ansible.builtin.apt:
    name:
      - targetcli-fb
      - python3-rtslib-fb
      - python3-configshell-fb
    state: present
    update_cache: true

- name: Enable and start iSCSI target service
  ansible.builtin.systemd:
    name: target
    enabled: true
    state: started

- name: Create iSCSI target configuration directory
  ansible.builtin.file:
    path: /etc/rtslib-fb-target
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Check if iSCSI target already exists
  ansible.builtin.command: targetcli ls /iscsi/{{ iscsi_target_iqn }}
  register: iscsi_target_exists
  changed_when: false
  failed_when: false

- name: Create iSCSI target (if not exists)
  ansible.builtin.command: targetcli /iscsi create {{ iscsi_target_iqn }}
  when: iscsi_target_exists.rc != 0
  register: iscsi_target_create_cmd
  changed_when: iscsi_target_create_cmd.rc == 0
  failed_when: false

- name: Create iSCSI portal (if target was created)
  ansible.builtin.command: targetcli /iscsi/{{ iscsi_target_iqn }}/tpg1/portals create {{ iscsi_portal_ip | default('0.0.0.0') }}
  when: 
    - iscsi_target_exists.rc != 0
    - iscsi_target_create_cmd is defined
    - iscsi_target_create_cmd.rc == 0
  register: iscsi_portal_create
  changed_when: iscsi_portal_create.rc == 0
  failed_when: false

- name: Enable CHAP authentication on TPG
  ansible.builtin.command: targetcli /iscsi/{{ iscsi_target_iqn }}/tpg1 set attribute authentication=1
  when: 
    - iscsi_chap_username is defined
    - iscsi_chap_password is defined
  register: iscsi_tpg_auth_setup
  changed_when: iscsi_tpg_auth_setup.rc == 0
  failed_when: false

- name: Create iSCSI backstore (optional, for Democratic-CSI not needed)
  ansible.builtin.command: targetcli /backstores/block create {{ iscsi_backstore_name | default('k8s-pool') }} {{ iscsi_backstore_device }}
  when: 
    - iscsi_backstore_device is defined
    - iscsi_backstore_device | length > 0
  register: iscsi_backstore_setup
  changed_when: iscsi_backstore_setup.rc == 0
  failed_when: false

- name: Check if iSCSI ACL already exists
  ansible.builtin.command: targetcli ls /iscsi/{{ iscsi_target_iqn }}/tpg1/acls/{{ iscsi_initiator_iqn }}
  register: iscsi_acl_exists
  changed_when: false
  failed_when: false
  when:
    - iscsi_chap_username is defined
    - iscsi_chap_password is defined
    - iscsi_initiator_iqn is defined

- name: Create iSCSI ACL
  ansible.builtin.command: targetcli /iscsi/{{ iscsi_target_iqn }}/tpg1/acls create {{ iscsi_initiator_iqn }}
  when: 
    - iscsi_chap_username is defined
    - iscsi_chap_password is defined
    - iscsi_initiator_iqn is defined
    - iscsi_acl_exists.rc != 0
  register: iscsi_acl_create
  changed_when: iscsi_acl_create.rc == 0
  failed_when: false

- name: Configure CHAP userid for iSCSI ACL
  ansible.builtin.command: targetcli /iscsi/{{ iscsi_target_iqn }}/tpg1/acls/{{ iscsi_initiator_iqn }} set attribute auth.userid={{ iscsi_chap_username }}
  when: 
    - iscsi_chap_username is defined
    - iscsi_chap_password is defined
    - iscsi_initiator_iqn is defined
  register: iscsi_chap_userid
  changed_when: iscsi_chap_userid.rc == 0
  failed_when: false

- name: Configure CHAP password for iSCSI ACL
  ansible.builtin.command: targetcli /iscsi/{{ iscsi_target_iqn }}/tpg1/acls/{{ iscsi_initiator_iqn }} set attribute auth.password={{ iscsi_chap_password }}
  when: 
    - iscsi_chap_username is defined
    - iscsi_chap_password is defined
    - iscsi_initiator_iqn is defined
  register: iscsi_chap_password_setup
  changed_when: iscsi_chap_password_setup.rc == 0
  failed_when: false

- name: Restore iSCSI configuration from saveconfig.json
  ansible.builtin.command: targetcli restoreconfig
  register: restore_config
  changed_when: restore_config.rc == 0
  failed_when: false
  when: 
    - (iscsi_target_create_cmd is defined and iscsi_target_create_cmd.changed) or 
      (iscsi_portal_create is defined and iscsi_portal_create.changed) or
      (iscsi_tpg_auth_setup is defined and iscsi_tpg_auth_setup.changed) or
      (iscsi_acl_create is defined and iscsi_acl_create.changed) or
      (iscsi_chap_userid is defined and iscsi_chap_userid.changed) or
      (iscsi_chap_password_setup is defined and iscsi_chap_password_setup.changed) or
      (iscsi_backstore_setup is defined and iscsi_backstore_setup.changed)

- name: Restart iSCSI target service after configuration
  ansible.builtin.systemd:
    name: target
    state: restarted
  when: 
    - (iscsi_target_create_cmd is defined and iscsi_target_create_cmd.changed) or 
      (iscsi_portal_create is defined and iscsi_portal_create.changed) or
      (iscsi_tpg_auth_setup is defined and iscsi_tpg_auth_setup.changed) or
      (iscsi_acl_create is defined and iscsi_acl_create.changed) or
      (iscsi_chap_userid is defined and iscsi_chap_userid.changed) or
      (iscsi_chap_password_setup is defined and iscsi_chap_password_setup.changed) or
      (iscsi_backstore_setup is defined and iscsi_backstore_setup.changed)
