---
- name: Install NFS kernel server packages
  ansible.builtin.apt:
    name:
      - nfs-kernel-server
      - nfs-common
    state: present
    update_cache: true

# Static NFS exports (optional - democratic-csi creates exports dynamically via ZFS)
- name: Create NFS export directory if it doesn't exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop: "{{ nfs_exports | map(attribute='path') | list }}"
  when: nfs_exports is defined and nfs_exports | length > 0

- name: Configure NFS exports
  ansible.builtin.lineinfile:
    path: /etc/exports
    line: "{{ item.path }} {{ item.allowed_networks | default(nfs_allowed_networks) | default('10.0.0.0/8') }}({{ item.options | default('rw,sync,no_subtree_check,no_root_squash') }})"
    regexp: "^{{ item.path | regex_escape() }}"
    state: present
    create: true
  loop: "{{ nfs_exports }}"
  when: nfs_exports is defined and nfs_exports | length > 0
  notify: restart nfs services

# Legacy single export support (deprecated, use nfs_exports list instead)
- name: Create legacy NFS export directory if it doesn't exist
  ansible.builtin.file:
    path: "{{ nfs_export_path }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  when:
    - nfs_export_path is defined
    - nfs_exports is not defined or nfs_exports | length == 0

- name: Configure legacy NFS export
  ansible.builtin.lineinfile:
    path: /etc/exports
    line: "{{ nfs_export_path }} {{ nfs_allowed_networks | default('10.0.0.0/8') }}(rw,sync,no_subtree_check,no_root_squash)"
    regexp: "^{{ nfs_export_path | regex_escape() }}"
    state: present
    create: true
  when:
    - nfs_export_path is defined
    - nfs_exports is not defined or nfs_exports | length == 0
  notify: restart nfs services

- name: Enable NFSv4
  ansible.builtin.lineinfile:
    path: /etc/default/nfs-kernel-server
    regexp: '^RPCNFSDCOUNT'
    line: 'RPCNFSDCOUNT=8'
    state: present

- name: Configure NFSv4 domain
  ansible.builtin.lineinfile:
    path: /etc/default/nfs-common
    regexp: '^NEED_STATD'
    line: 'NEED_STATD=no'
    state: present

- name: Configure NFSv4 ID mapping
  ansible.builtin.lineinfile:
    path: /etc/idmapd.conf
    regexp: '^Domain'
    line: 'Domain = {{ nfs_domain | default("local") }}'
    state: present
  notify: restart nfs services

- name: Enable and start NFS kernel server
  ansible.builtin.systemd:
    name: nfs-kernel-server
    enabled: true
    state: started

- name: Export NFS shares
  ansible.builtin.command: exportfs -ra
  changed_when: false
